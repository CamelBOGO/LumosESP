<!DOCTYPE html>
<html>
    <head>
        <link href="./css/pico.indigo.min.css" rel="stylesheet" />

        <title>LumosESP</title>
        <meta charset="UTF-8" />
        <link rel="icon" href="data:," />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    </head>
    <body>
        <!-- The Title of The Website -->
        <div style="display: flex; justify-content: center">
            <h1
                style="
                    text-align: center;
                    margin: 16px 0px 0px;
                    background: linear-gradient(to right, #c33764, #1d2671);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                ">
                LumosESP
            </h1>
            <hr />
        </div>
        <hr />

        <!-- The Form of Colour Selection -->
        <div id="selectColour" class="container-fluid" style="max-width: 768px">
            <form>
                <label for="selectColour">Select a colour:</label>
                <select id="selectColour" onchange="putColour(event.target.value)">
                    <option selected value="off">Off</option>
                    <option value="0xFFFFFF">White</option>
                    <option value="0xFF0000">Red</option>
                    <option value="0xFFA500">Orange</option>
                    <option value="0xFFD700">Gold</option>
                    <option value="0xFFFF00">Yellow</option>
                    <option value="0x00FF00">Green</option>
                    <option value="0x00FFFF">Cyan</option>
                    <option value="0x0000FF">Blue</option>
                    <option value="0xFF00FF">Magenta</option>
                    <option value="0xFFC0CB">Pink</option>
                    <option value="cycle">Cycle</option>
                </select>
            </form>

            <!-- The Text of Current Colour -->
            <p>Current Colour:</p>
            <p id="currentColour">N/A</p>

            <!-- WiFi Status -->
            <p>WiFi Status:</p>
            <p id="wifiStatus">N/A</p>
            <p id="ipAddress">N/A</p>

            <button id="turnOffApBtn" onclick="turnOffAp()" style="width: 100%; display: none">Turn Off AP</button>

            <!-- The Form of Submitting the WiFi password -->
            <div id="wifiFormDiv">
                <h4>WiFi Configuration</h4>
                <form id="wifiForm" autocomplete="off">
                    <fieldset>
                        <input name="login" placeholder="SSID" />
                        <input type="password" name="password" placeholder="Password" />
                        <button type="submit">Submit</button>
                    </fieldset>
                </form>
            </div>
        </div>
    </body>

    <!-- Script Here -->
    <script>
        function decToHexColour(dec) {
            return "#" + dec.toString(16).padStart(6, "0");
        }

        async function setColourText() {
            try {
                // Fetch the current LED colour.
                const response = await fetch("/api/led");

                // Check if the response was successful.
                if (!response.ok) {
                    console.error("Failed to fetch LED colour");
                    return;
                }

                // Parse the response JSON.
                const data = await response.json();

                // Set the current colour text.
                if (data.led) {
                    if (data.led === "cycle") document.getElementById("currentColour").innerText = "Cycle";
                    else document.getElementById("currentColour").innerText = decToHexColour(data.led);
                } else {
                    console.error("Invalid response from server.");
                }
            } catch (error) {
                console.error("An error occurred:", error);
            }
        }

        async function putColour(colourData) {
            try {
                if (colourData !== "cycle") {
                    // Convert the colour hex string to a number.
                    colourData = parseInt(colourData);
                }

                // Send a PUT request to the server to change the LED colour.
                const response = await fetch("/api/led", {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ led: colourData }),
                });

                // Check if the response was successful.
                if (response.status !== 200) {
                    console.error("Failed to change LED colour");
                    return;
                }

                const data = await response.json();

                // Set the current colour text.
                if (data.led) {
                    if (data.led === "cycle") document.getElementById("currentColour").innerText = "Cycle";
                    else document.getElementById("currentColour").innerText = decToHexColour(data.led);
                } else {
                    console.error("Invalid response from server.");
                }
            } catch (error) {
                console.error("An error occurred:", error);
            }
        }

        async function getWifiStatus() {
            try {
                // Fetch the current WiFi status.
                const response = await fetch("/api/wifi");

                // Check if the response was successful.
                if (!response.ok) {
                    console.error("Failed to fetch WiFi status");
                    return;
                }

                // Parse the response JSON.
                const data = await response.json();

                // Set the current WiFi status text.
                if (data.mode == 0) {
                    document.getElementById("wifiStatus").innerText = "AP Mode";
                } else {
                    if (data.mode == 1) {
                        document.getElementById("wifiStatus").innerText = "WiFi Mode";
                        document.getElementById(
                            "ipAddress"
                        ).innerHTML = `<a href="http://${data.ip}">http://${data.ip}</a>`;
                    }
                    if (data.mode == 2) {
                        document.getElementById("wifiStatus").innerText = "AP/WiFi Mode (Turn off AP to save power)";
                        document.getElementById(
                            "ipAddress"
                        ).innerHTML = `<a href="http://${data.ip}">http://${data.ip}</a>`;
                        document.getElementById("turnOffApBtn").style.display = "";
                    }
                    // Hide the WiFi form if the device is already connected to a network.
                    document.getElementById("wifiFormDiv").style.display = "none";
                }
            } catch (error) {
                console.error("An error occurred:", error);
            }
        }

        async function handleWifiSubmit(event) {
            event.preventDefault();

            try {
                // Get the form data.
                const formData = new FormData(event.target);

                // Send a PUT request to the server to change the WiFi configuration.
                const response = await fetch("/api/wifi", {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        ssid: formData.get("login"),
                        password: formData.get("password"),
                    }),
                });

                // Check if the response was successful.
                if (response.status !== 200) {
                    console.error("Failed to change WiFi configuration");
                    return;
                }

                // Parse the response JSON.
                const data = await response.json();

                // If the response was successful, update the WiFi status text.
                document.getElementById("wifiStatus").style.color = "red";
                document.getElementById("wifiStatus").innerHTML = `
                    You have submitted the WiFi config to ESP. If the password is correct, it will connect to the WiFi. 
                    Refresh the page after a few seconds to see the IP address.
                    Use the address <a href="http://${data.host}.local">http://${data.host}.local</a> to access the ESP via the same WiFi network.
                    Android phone may not support mDNS, so you may need to use the IP address to access the ESP. 
                    The IP address is assigned by the router, so you need to check the router's DHCP client list. 
                    It may look like <a href="http://${data.ip}">${data.ip}</a>.
                `;
            } catch (error) {
                console.error("An error occurred:", error);
            }
        }

        async function turnOffAp() {
            try {
                // Send a PUT request to set the WiFi mode to WiFi only.
                const response = await fetch("/api/network_mode", {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ mode: 1 }),
                });

                // Check if the response was successful.
                if (response.status !== 200) {
                    console.error("Failed to turn off AP");
                    return;
                }

                const data = await response.json();

                // Set
                if (data.mode == 1) {
                    document.getElementById("wifiStatus").innerText = "WiFi Mode";
                    document.getElementById("turnOffApBtn").style.display = "none";
                }
            } catch (error) {
                console.error("An error occurred:", error);
            }
        }

        // Main Script
        document.getElementById("wifiForm").addEventListener("submit", handleWifiSubmit);

        setColourText();
        getWifiStatus();
    </script>
</html>
